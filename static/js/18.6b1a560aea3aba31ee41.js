webpackJsonp([18],{AjLI:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=n("BO1k"),r=n.n(a),o=n("Xxa5"),i=n.n(o),s=n("exGp"),c=n.n(s),l=n("v1w/"),u=(n("U/y8"),n("DHPL")),d=(n("YaEn"),n("ONoB")),f=n("oAV5"),m=n("vaUZ"),p=n.n(m),b=n("geuY"),h=n.n(b),k=Object(l.d)(),v={name:"BulkPayPage",components:{},data:function(){return{bSignedIn:l.g.isUserSignedIn(),selfAddr:l.g.isUserSignedIn()?Object(l.a)():"",tokenType:"STX",myBalanceSTX:"-",maxSendListLen:200,tokenInfo:{bLoadFlag:!1,myBalance:"-",name:"",nameList:[],decimal:0,contract:"",parts:[]},sendList:[{receiver:"",amount:"",memo:""}],bulkAddInfo:{bVisible:!1,recInfoStr:"",memo:""},tips:{invalidTokenContract:"Invalid token contract"}}},mounted:function(){var e=this;return c()(i.a.mark(function t(){return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:e.bSignedIn&&e.refreshSTXBalance();case 1:case"end":return t.stop()}},t,e)}))()},computed:{needInputTokenContract:function(){return"FT"==this.tokenType&&0==this.tokenInfo.contract.trim().length},totalAmount:function(){var e=0,t="STX"==this.tokenType?6:this.tokenInfo.decimal,n=!0,a=!1,o=void 0;try{for(var i,s=r()(this.sendList);!(n=(i=s.next()).done);n=!0){var c=i.value;parseFloat(c.amount)&&(e+=this.getAccurateAmount(c.amount,t))}}catch(e){a=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(a)throw o}}return e/Math.pow(10,t)},myBalanceStr:function(){return this.bSignedIn?"STX"==this.tokenType?this.myBalanceSTX:this.tokenInfo.myBalance:"-"},exceedBalance:function(){if("STX"==this.tokenType){if("-"!=this.myBalanceSTX&&this.totalAmount>this.myBalanceSTX)return!0}else if("-"!=this.tokenInfo.myBalance&&this.totalAmount>this.tokenInfo.myBalance)return!0;return!1}},methods:{onChangeTokenType:function(){if("FT"==this.tokenType&&!this.tokenInfo.bLoadFlag){this.tokenInfo.bLoadFlag=!0;var e=localStorage.getItem("x/bpp/tc");e&&e!=this.tokenInfo.contract&&(this.tokenInfo.contract=e,this.handleChangeContract())}},onClickDeleteBulkItem:function(e,t){this.sendList.splice(e,1)},onClickSignIn:function(){Object(l.e)()},onChangeFTContract:function(){this.handleChangeContract()},handleChangeContract:function(){var e=this;return c()(i.a.mark(function t(){var n,a,r,o,s,c;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(e.bSignedIn){t.next=2;break}return t.abrupt("return");case 2:if(e.tokenInfo.myBalance="-",e.tokenInfo.name="",e.tokenInfo.nameList=[],e.tokenInfo.decimal=0,e.tokenInfo.parts=[],0!=e.tokenInfo.contract.trim().length){t.next=10;break}return localStorage.setItem("x/bpp/tc",""),t.abrupt("return");case 10:t.prev=10,2==(n=e.tokenInfo.contract.trim().split(".")).length&&(Object(d.j)(n[0],n[1]),e.tokenInfo.parts=[n[0],n[1]]);case 13:if(t.prev=13,2==e.tokenInfo.parts.length){t.next=17;break}return Object(f.a)(e,e.tips.invalidTokenContract),t.abrupt("return");case 17:return t.finish(13);case 18:a=e.createLoading("Loading"),r=0,o=!1,s=e,c=function(e,t,n){t||(o=!0,Object(f.a)(s,n)),2==++r&&(a.close(),o||localStorage.setItem("x/bpp/tc",s.tokenInfo.contract)),t&&2==e&&s.refreshFTBalance()},e.queryName(c),e.queryDecimal(c);case 25:case"end":return t.stop()}},t,e,[[10,,13,18]])}))()},queryName:function(e){var t=this;return c()(i.a.mark(function n(){var a,o,s,c,l,u,d,f;return i.a.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,p()(k.coreApiUrl+"/v2/contracts/interface/"+t.tokenInfo.parts[0]+"/"+t.tokenInfo.parts[1]);case 2:if(200!=(a=n.sent).status){n.next=33;break}return n.next=6,a.json();case 6:if(0!=(o=n.sent).fungible_tokens.length){n.next=10;break}return e(1,!1,t.tips.invalidTokenContract),n.abrupt("return");case 10:for(t.tokenInfo.name=o.fungible_tokens[0].name,s=!0,c=!1,l=void 0,n.prev=14,u=r()(o.fungible_tokens);!(s=(d=u.next()).done);s=!0)f=d.value,t.tokenInfo.nameList.push(f.name);n.next=22;break;case 18:n.prev=18,n.t0=n.catch(14),c=!0,l=n.t0;case 22:n.prev=22,n.prev=23,!s&&u.return&&u.return();case 25:if(n.prev=25,!c){n.next=28;break}throw l;case 28:return n.finish(25);case 29:return n.finish(22);case 30:e(1,!0),n.next=34;break;case 33:e(1,!1,"Request fail, status="+a.status);case 34:case"end":return n.stop()}},n,t,[[14,18,22,30],[23,,25,29]])}))()},queryDecimal:function(e){var t=this;return c()(i.a.mark(function n(){var a,r,o;return i.a.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return a={contractAddress:t.tokenInfo.parts[0],contractName:t.tokenInfo.parts[1],functionName:"get-decimals",functionArgs:[],network:k,senderAddress:Object(l.a)()},n.prev=1,n.next=4,Object(d.i)(a);case 4:r=n.sent,o=Object(d.m)(r),t.tokenInfo.decimal=o.value,e(2,!0),n.next=13;break;case 10:n.prev=10,n.t0=n.catch(1),e(2,!1,"Qeury decimal fail");case 13:case"end":return n.stop()}},n,t,[[1,10]])}))()},onClickRefreshBalance:function(){this.refreshBalance()},refreshBalance:function(){var e=this;return c()(i.a.mark(function t(){return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(e.bSignedIn){t.next=2;break}return t.abrupt("return");case 2:if("STX"!=e.tokenType){t.next=8;break}return t.next=5,e.refreshSTXBalance();case 5:return t.abrupt("return",t.sent);case 8:return t.next=10,e.refreshFTBalance();case 10:return t.abrupt("return",t.sent);case 11:case"end":return t.stop()}},t,e)}))()},refreshSTXBalance:function(){var e=this;return c()(i.a.mark(function t(){var n,a,r;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e.myBalanceSTX="-",t.next=3,p()(k.coreApiUrl+"/v2/accounts/"+Object(l.a)());case 3:if(200!=(n=t.sent).status){t.next=11;break}return t.next=7,n.json();case 7:return a=t.sent,r=Object(d.p)(a.balance),e.myBalanceSTX=r.value.toNumber()/1e6,t.abrupt("return",!0);case 11:case"end":return t.stop()}},t,e)}))()},refreshFTBalance:function(){var e=this;return c()(i.a.mark(function t(){var n,a,r;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e.tokenInfo.myBalance="-",n={contractAddress:e.tokenInfo.parts[0],contractName:e.tokenInfo.parts[1],functionName:"get-balance",functionArgs:[Object(d.C)(Object(l.a)())],network:k,senderAddress:Object(l.a)()},t.prev=2,t.next=5,Object(d.i)(n);case 5:return a=t.sent,r=Object(d.m)(a),e.tokenInfo.myBalance=r.value/Math.pow(10,e.tokenInfo.decimal),t.abrupt("return",!0);case 11:return t.prev=11,t.t0=t.catch(2),Object(f.j)(e,"get balance error"),t.abrupt("return",!1);case 15:case"end":return t.stop()}},t,e,[[2,11]])}))()},onClickAdd:function(){this.sendList.push({receiver:"",amount:"",memo:""})},onClickBulkAdd:function(){this.bulkAddInfo.bVisible=!0,this.bulkAddInfo.recInfoStr=""},onClickRemoveAll:function(){var e=this;this.$confirm("Will remove all items, are you sure?","",{confirmButtonText:"Yes",cancelButtonText:"No"}).then(function(){e.sendList.splice(0,e.sendList.length)})},onCloseDrawer:function(){if(0==this.bulkAddInfo.recInfoStr.trim().length)this.bulkAddInfo.bVisible=!1;else{var e=this;this.$confirm("Will close the bulk add dialog, are you sure?","",{confirmButtonText:"Yes",cancelButtonText:"No"}).then(function(){e.bulkAddInfo.bVisible=!1})}},onClickSureBulkAdd:function(){for(var e=this.sendList.length,t=this.bulkAddInfo.recInfoStr.trim().match(/[^\r\n]+/g),n={},a=null,r=0;r<t.length&&!a;r++){var o=t[r],i=o.split(",");if(2!=i.length){a="Line "+(r+1)+", invalid format ("+o+").";break}try{var s=i[0].split(".");1==s.length?Object(d.C)(s[0]):Object(d.j)(s[0],s[1])}catch(e){a="Line "+(r+1)+", invalid address ("+o+").";break}if(i[0]==Object(l.a)()){a="Line "+(r+1)+", address cannot be self ("+o+").";break}if(n[i[0]]){a="Line "+(r+1)+"'s address equals with line "+n[i[0]]+"'s.";break}var c=parseFloat(i[1]);if(!c){a="Line "+(r+1)+", invalid amount ("+o+").";break}n[i[0]]=r+1,this.sendList.push({receiver:i[0],amount:c,memo:this.bulkAddInfo.memo})}if(a)return this.sendList.splice(e),void Object(f.a)(this,a);1==e&&""==this.sendList[0].receiver&&""==this.sendList[0].amount&&this.sendList.splice(0,1),this.sendList.length>this.maxSendListLen&&this.sendList.splice(this.maxSendListLen),this.bulkAddInfo.bVisible=!1},onClickPay:function(){var e=!1;if("STX"==this.tokenType)for(var t=0;t<this.sendList.length;t++)this.sendList[t].memo.trim().length>0&&(e=!0);else e=!0;var n=null;n="STX"==this.tokenType?e?"bulk-pay-with-memo":"bulk-pay":"bulk-pay-ft";var a=null,r=Object(d.r)();r.list=[];for(var o={},i=0;i<this.sendList.length;i++){var s=this.sendList[i],c=null,u=s.receiver.trim();try{var m=u.split(".");c=1==m.length?Object(d.C)(m[0]):Object(d.j)(m[0],m[1])}catch(e){a="Line "+(i+1)+", invalid address ("+s.receiver+").";break}if(u==Object(l.a)()){a="Line "+(i+1)+", address cannot be self ("+s.receiver+").";break}if(o[u]){a="Line "+(i+1)+"'s address equals with line "+o[u]+"'s.";break}var p=parseFloat(s.amount);if(!p){a="Line "+(i+1)+", invalid amount ("+s.amount+").";break}o[u]=i+1;var b={addr:c},h=0;if(!(h="STX"==this.tokenType?this.getAccurateAmount(p,6):this.getAccurateAmount(p,this.tokenInfo.decimal))){a="Line "+(i+1)+", invalid amount ("+s.amount+").";break}b.amount=Object(d.H)(h),e&&(b.memo=s.memo.trim().length>0?Object(d.B)(Object(d.h)(s.memo.trim())):Object(d.y)()),r.list.push(Object(d.G)(b))}if(a)Object(f.a)(this,a);else if("STX"==this.tokenType){if(this.myBalanceSTX<this.totalAmount)return void Object(f.a)(this,"Balance unenough.");if(this.myBalanceSTX==this.totalAmount)return void Object(f.a)(this,"No remain for gas fee.");if(this.myBalanceSTX-this.totalAmount<1){var k=this;this.$confirm("Balance: "+this.myBalanceSTX+" STX, Total pay: "+this.totalAmount+" STX, so make sure gas fee no more than "+(this.myBalanceSTX-this.totalAmount).toFixed(6)+" STX.","",{confirmButtonText:"Ok",cancelButtonText:"Cancel"}).then(function(){k.startPay(n,r)})}else this.startPay(n,r)}else{if(this.totalAmount>this.tokenInfo.myBalance)return void Object(f.a)(this,"Balance unenough.");this.startPay(n,r)}},getAccurateAmount:function(e,t){var n=e.toString();if("1"==n.substring(0,1)){var a=n.indexOf("e-");if(-1!=a){var r=parseInt(n.substring(a+2)),o=n.indexOf("."),i="";i=-1!=o?""+n.substring(0,o)+n.substring(o+1,a):""+n.substring(0,a),n="0."+"0".repeat(r-1)+i}}var s=n.indexOf(".");if(-1!=s){var c=n.length-s-1;n=c<=t?""+n.substring(0,s)+n.substring(s+1)+"0".repeat(t-c):""+n.substring(0,s)+n.substring(s+1,s+1+t)}else n=""+n+"0".repeat(t);return"0"==n.substring(0,1)&&(n=n.substring(1)),n.match(/^0*$/g)?0:parseInt(n)},startPay:function(e,t){var n=[],a=[];if("bulk-pay"==e||"bulk-pay-with-memo"==e){n.push(Object(d.F)()),n.push(t);var r=this.getAccurateAmount(this.totalAmount,6);console.log("____stx_amountIntV",r),a.push(Object(d.x)(Object(l.a)(),d.d.LessEqual,new h.a(r)))}else if("bulk-pay-ft"==e){n.push(Object(d.F)()),n.push(Object(d.j)(this.tokenInfo.parts[0],this.tokenInfo.parts[1])),n.push(t);var o=Object(d.k)(this.tokenInfo.parts[0],this.tokenInfo.parts[1],this.tokenInfo.name),i=this.getAccurateAmount(this.totalAmount,this.tokenInfo.decimal);console.log("____ft_amountIntV",i),a.push(Object(d.v)(Object(l.a)(),d.d.LessEqual,new h.a(i),o))}var s=this,c={contractAddress:"SPMCWHJY8CJX5WP0PKKYS12FWYC1J2VNXDT42B5R",contractName:e,functionName:"bulk-pay",functionArgs:n,network:k,appDetails:Object(l.b)(),postConditions:a,onFinish:function(e){s.$notify({title:"Pay sent",message:"Transaction has been sent, wait a while to be finished."})}};Object(u.c)(c)},createLoading:function(e,t){return this.$loading({lock:!0,text:e,spinner:"el-icon-loading",background:t||"rgba(0, 0, 0, 0.05)"})},onClickTest1:function(){},onClickTest2:function(){}}},g={render:function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("div",{attrs:{id:"main"}},[n("div",[n("span",[e._v("Token:")]),e._v(" "),n("el-select",{staticClass:"ib",staticStyle:{width:"100px"},attrs:{size:"small"},on:{change:e.onChangeTokenType},model:{value:e.tokenType,callback:function(t){e.tokenType=t},expression:"tokenType"}},[n("el-option",{attrs:{value:"STX",label:"STX"}}),e._v(" "),n("el-option",{attrs:{value:"FT",label:"FT"}})],1),e._v(" "),"FT"==e.tokenType?n("el-input",{staticClass:"ib",staticStyle:{"max-width":"550px"},attrs:{clearable:"",disabled:!e.bSignedIn,size:"small",placeholder:"Token contract"},on:{change:e.onChangeFTContract},model:{value:e.tokenInfo.contract,callback:function(t){e.$set(e.tokenInfo,"contract",t)},expression:"tokenInfo.contract"}}):e._e(),e._v(" "),"FT"==e.tokenType&&e.tokenInfo.nameList.length>0?n("el-select",{staticStyle:{width:"150px"},attrs:{size:"small",placeholder:"Please select"},on:{change:e.onClickRefreshBalance},model:{value:e.tokenInfo.name,callback:function(t){e.$set(e.tokenInfo,"name",t)},expression:"tokenInfo.name"}},e._l(e.tokenInfo.nameList.length,function(t){return n("el-option",{key:t,attrs:{value:e.tokenInfo.nameList[t-1],label:e.tokenInfo.nameList[t-1]}})}),1):e._e()],1),e._v(" "),n("el-table",{attrs:{id:"bulkRegTable","empty-text":"Empty",size:"mini",data:e.sendList}},[n("el-table-column",{attrs:{type:"index",width:"46"}}),e._v(" "),n("el-table-column",{attrs:{label:"Receiver",width:"520"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("el-input",{attrs:{clearable:"",disabled:!e.bSignedIn||e.needInputTokenContract,placeholder:"receiver",maxlength:"150"},model:{value:t.row.receiver,callback:function(n){e.$set(t.row,"receiver",n)},expression:"scope.row.receiver"}})]}}])}),e._v(" "),n("el-table-column",{attrs:{label:"Amount",width:"160"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("el-input",{attrs:{clearable:"",disabled:!e.bSignedIn||e.needInputTokenContract,placeholder:"amount",maxlength:"50"},model:{value:t.row.amount,callback:function(n){e.$set(t.row,"amount",n)},expression:"scope.row.amount"}})]}}])}),e._v(" "),n("el-table-column",{attrs:{label:"Memo(optional, max 34 characters)",width:"320"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("el-input",{attrs:{clearable:"",disabled:!e.bSignedIn||e.needInputTokenContract,placeholder:"memo",maxlength:"34"},model:{value:t.row.memo,callback:function(n){e.$set(t.row,"memo",n)},expression:"scope.row.memo"}})]}}])}),e._v(" "),n("el-table-column",{attrs:{label:"Action"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("el-button",{attrs:{disabled:!e.bSignedIn||e.needInputTokenContract,type:"danger",icon:"el-icon-delete",circle:""},on:{click:function(n){return e.onClickDeleteBulkItem(t.$index,t.row)}}})]}}])})],1),e._v(" "),n("div",{staticStyle:{"margin-left":"55px","margin-top":"12px"}},[e.sendList.length==e.maxSendListLen?n("div",{staticStyle:{"font-weight":"bold","margin-bottom":"8px"}},[e._v("Max 200 items.")]):e._e(),e._v(" "),e.bSignedIn?e._e():n("el-button",{attrs:{type:"primary"},on:{click:function(t){return e.onClickSignIn()}}},[e._v("Sign in")]),e._v(" "),n("el-button",{attrs:{disabled:!e.bSignedIn||e.needInputTokenContract||e.sendList.length>=e.maxSendListLen,type:"primary",plain:""},on:{click:function(t){return e.onClickAdd()}}},[e._v("   Add   ")]),e._v(" "),n("el-button",{attrs:{disabled:!e.bSignedIn||e.needInputTokenContract,type:"primary",plain:""},on:{click:function(t){return e.onClickBulkAdd()}}},[e._v("Bulk add")]),e._v(" "),n("el-button",{attrs:{disabled:!e.bSignedIn||e.needInputTokenContract,type:"info",plain:""},on:{click:function(t){return e.onClickRemoveAll()}}},[e._v("Remove all")]),e._v(" "),e.bSignedIn?n("div",{staticStyle:{"margin-top":"32px"}},[n("div",[n("span",{staticStyle:{"min-width":"75px",display:"inline-block"}},[e._v("Total pay:")]),e._v(" "),n("span",{style:{color:e.exceedBalance?"red":"black"}},[e._v(e._s(e.totalAmount)+" ")]),e._v("\n          "+e._s("STX"==e.tokenType?"STX":e.tokenInfo.name)+"\n        ")]),e._v(" "),n("div",{staticStyle:{"margin-top":"16px"}},[n("span",{staticStyle:{"min-width":"75px",display:"inline-block"}},[e._v("Balance:")]),e._v(" "),n("span",{directives:[{name:"loading",rawName:"v-loading",value:"-"==e.myBalanceStr&&("STX"==e.tokenType||e.tokenInfo.decimal>0),expression:'myBalanceStr=="-" && (tokenType=="STX" || tokenInfo.decimal>0)'}]},[e._v("\n            "+e._s(e.myBalanceStr)+" "+e._s("STX"==e.tokenType?"STX":e.tokenInfo.name)+"\n          ")]),e._v(" "),"-"!=e.myBalanceStr?n("el-button",{staticStyle:{"margin-left":"4px"},attrs:{type:"primary",plain:"",size:"mini"},on:{click:function(t){return e.onClickRefreshBalance()}}},[e._v("Refresh")]):e._e(),e._v(" "),"-"!=e.myBalanceStr?n("span",{staticStyle:{color:"grey","margin-left":"8px"}},[e._v("\n            (Current account: "+e._s(e.selfAddr)+")\n          ")]):e._e()],1),e._v(" "),n("el-button",{staticStyle:{"margin-top":"12px"},attrs:{disabled:e.totalAmount<=0||e.needInputTokenContract,type:"primary"},on:{click:function(t){return e.onClickPay()}}},[e._v("   Pay   ")])],1):e._e()],1),e._v(" "),n("el-drawer",{attrs:{title:"Bulk add",visible:e.bulkAddInfo.bVisible,"before-close":e.onCloseDrawer,direction:"ltr",size:"750px"},on:{"update:visible":function(t){return e.$set(e.bulkAddInfo,"bVisible",t)}}},[n("div",{staticStyle:{width:"650px","margin-left":"50px"}},[n("div",{staticClass:"bulkTitle",staticStyle:{color:"grey"}},[e._v("Input "),n("span",{staticStyle:{color:"black"}},[e._v("address,amount")]),e._v(" per line:")]),e._v(" "),n("el-input",{attrs:{type:"textarea",placeholder:"address,amount",rows:"20",clearable:""},model:{value:e.bulkAddInfo.recInfoStr,callback:function(t){e.$set(e.bulkAddInfo,"recInfoStr",t)},expression:"bulkAddInfo.recInfoStr"}}),e._v(" "),n("div",{staticStyle:{"margin-top":"20px"}}),e._v(" "),n("div",{staticClass:"bulkTitle"},[e._v("Memo(optional, max 34 characters):")]),e._v(" "),n("el-input",{attrs:{clearable:"",placeholder:"memo",maxlength:"34"},model:{value:e.bulkAddInfo.memo,callback:function(t){e.$set(e.bulkAddInfo,"memo",t)},expression:"bulkAddInfo.memo"}}),e._v(" "),n("div",{staticClass:"bulkTitle",staticStyle:{color:"grey","font-size":"14px"}},[e._v("(Left memo empty can save gas)")]),e._v(" "),n("el-button",{staticStyle:{"margin-top":"12px"},attrs:{type:"primary",disabled:0==e.bulkAddInfo.recInfoStr.trim().length},on:{click:function(t){return e.onClickSureBulkAdd()}}},[e._v("   Add   ")])],1)])],1)])},staticRenderFns:[]};var y=n("VU/8")(v,g,!1,function(e){n("eSbO")},"data-v-573d81c6",null);t.default=y.exports},eSbO:function(e,t){}});